# 語音系統設定文檔

## 概述

本文檔記錄廣東話語音系統的性能優化設定，特別是超時保護和自動截斷機制。

---

## 性能基準

### 硬件環境
- CPU: Intel N100 (4 cores, 11GB RAM)
- 模型: Fun-CosyVoice3-0.5B
- RTF (Real-Time Factor): 12.43

### 合成時間估算
- **每字約 1.5 秒**（N100 CPU，無 GPU 加速）
- 示例：
  - 10 字 → 15 秒
  - 20 字 → 30 秒
  - 30 字 → 45 秒
  - 40 字 → 60 秒

---

## 關鍵設定

### 超時保護（Timeout Protection）

#### 設置值
```python
timeout = 50  # 秒
```

#### 觸發行為
- 超過 50 秒合成時間時自動中斷
- 返回文字回應 + 超時提示
- 防止整個請求超時

#### 實現方式
```python
# voice_tts.py
import threading

def synthesize_speech(..., timeout=50):
    thread = threading.Thread(target=_synthesize)
    thread.daemon = True
    thread.start()
    thread.join(timeout=timeout)

    if thread.is_alive():
        # 超時處理
        result['timed_out'] = True
        result['error'] = f'Synthesis timeout after {timeout}s'
```

---

### 自動截斷（Auto Truncation）

#### 設置值
```python
max_safe_seconds = 50  # 秒
max_safe_chars = 33    # 字（50 / 1.5）
```

#### 觸發條件
- 預計合成時間 > 50 秒（文本 > 33 字）
- 自動截斷為 33 字 + "..."
- 確保合成時間可控

#### 實現方式
```python
# voice_integration.py
def respond_speech(self, text, ...):
    estimated_seconds = len(text) * 1.5
    max_safe_chars = int(50 / 1.5)  # 33

    if len(text) > max_safe_chars:
        original_text = text
        processed_text = text[:max_safe_chars] + "..."
        text_truncated = True

        print(f"⚠️ 文本過長（{len(original_text)} 字，預計 {estimated_seconds:.1f} 秒 > 50 秒）")
        print(f"✂️  自動截斷為 {max_safe_chars} 字以保證在 50 秒內完成")
```

---

## 雙重保護機制

### 結合策略
1. **主動保護**（自動截斷）：
   - 合成前檢查預計時間
   - 超過 33 字自動截斷
   - 確保總是能合成

2. **被動保護**（超時保護）：
   - 50 秒超時限制
   - 超時返回文字
   - 保底文字響應

### 處理流程
```
輸入文本
  ↓
檢查長度（> 33字？）
  ├─ 是 → 截斷為 33 字 → 合成（預計 < 50 秒）
  └─ 否 → 直接合成（預計 < 50 秒）
      ↓
  檢查超時（> 50秒？）
    ├─ 是 → 返回文字
    └─ 否 → 返回文字+語音
```

---

## 用戶偏好設定

### 優先級
用戶可通過以下方式調整邊界：

1. **修改 `voice_integration.py`**:
```python
max_safe_seconds = 50  # 可調整為 60/70 等
max_safe_chars = int(max_safe_seconds / 1.5)
```

2. **修改 `voice_tts.py`**:
```python
DEFAULT_TIMEOUT = 50  # 可調整超時時間
```

### 推薦設定

| 使用場景 | 建議邊界 | 原因 |
|---------|---------|------|
| 日常使用（N100 CPU） | 50 秒（33 字） | 平衡速度和體驗 |
| 高性能 GPU | 120 秒（80 字） | GPU 快速，可接受更長 |
| 低頻次使用 | 60 秒（40 字） | 不介意等待，追求完整性 |

---

## 顯示提示

### 截斷提示
```
⚠️ 文本過長（45 字，預計 67.5 秒 > 50 秒）
✂️  自動截斷為 33 字以保證在 50 秒內完成
```

### 合成提示
```
⏳ 語音合成中...（預計 49.5 秒）
```

### 超時提示
```
⚠️ 語音合成超時，僅返回文字回應
```

### 截斷提示

```
⚠️ 文本過長（X 字，預計 Y 秒 > 50 秒）
✂️  自動截斷為 33 字以保證在 50 秒內完成
```

**重要說明**（用戶偏好）：
- **語音**：使用截斷后的短文本（33 字）→ 合成語音 → 發送到用戶
- **文字**：使用原始的完整長文本（未截斷）→ 發送到用戶
- **目的**：用戶既能聽到短語音（可控），又能看到完整文字（不錯失內容）

---

## 性能數據

### 合成時間表格

| 文本長度 | 預計時間 | 處理方式 | 實際時間（N100）|
|---------|---------|---------|----------------|
| ≤ 10 字 | ≤ 15 秒 | 正常合成 | 15-20 秒 |
| ≤ 33 字 | ≤ 50 秒 | 正常合成 | 45-55 秒 |
| 34-50 字 | 51-75 秒 | 截斷（→33字）| 45-55 秒 |
| 51-100 字 | 76-150 秒 | 截斷（→33字）| 45-55 秒 |
| 100+ 字 | 150+ 秒 | 截斷（→33字）| 45-55 秒 |

### 音頻文件大小
- 格式：WAV 24kHz mono
- 大小：~40 KB/秒
- 33 字（~20秒音頻）≈ 800 KB

---

## 故障排除

### 問題：等太久
**原因**：文本超過 33 字
**解決方案**：
- 自動截斷會觸發
- 用戶可調整邊界設置
- 或禁用自動截斷，等待完整合成

### 問題：仍然超時
**原因**：系統負載高
**解決方案**：
- 超時保護會返回文字
- 確保至少有文字回應
- 檢查系統資源使用

### 問題：想聽完整回應
**解決方案**：
- 臨時調整 `max_safe_seconds` 設置
- 或關閉語音輸出後查看完整文字

---

## 更新記錄

| 日期 | 更新內容 | 版本 |
|------|---------|------|
| 2026-02-11 15:30 | 實現超時保護機制 | 1.1 |
| 2026-02-11 15:40 | 添加自動截斷功能（50秒邊界）| 1.2 |
| 2026-02-11 15:50 | 確認 50 秒邊界設定 | 1.2.1 |

---

**最後更新**: 2026-02-11 16:35
**適用版本**: v1.2+
