# 語音系統故障排除指南

## 問題：時常收不到文字+語音回應

### 問題原因

🎯 **主因：語音合成時間過長**

- **CPU 合成時間**: ~110秒/每秒音頻（RTF 12.43）
- **典型回應** (3-5秒文字): 需要 33-55秒 CPU 時間
- **OpenClaw 超時**: 可能存在默認超時（如60秒）
- **結果**: 如果合成時間超過超時設定，請求被取消⇒用戶收不到回應

---

## 具體原因分析

| 原因 | 說明 | 解決方案 |
|------|------|----------|
| ⏱️ **合成時間過長** | N100 CPU 無 GPU 加速 | 已知限制，無法優化 |
| 🔇 **無錯誤反饋** | 錯誤被靜默處理 | 需要改進錯誤處理 |
| ⚙️ **OpenClaw 超時** | 默認超時可能過短 | 檢查配置 |
| 📝 **文本過長** | 輸入文本越长 = 時間越長 | 優化文本長度 |

---

## 診斷步驟

### 1. 檢查語音輸出狀態

```bash
cat /home/ubuntu/.openclaw/workspace/skills/cantonese-voice/voice_output_state.json
```

如果 `"enabled": false`，語音輸出關閉，不會生成音頻。

### 2. 檢查最近的語音文件

```bash
ls -lht /home/ubuntu/桌面/ok/voice_*.wav | head -5
```

確認是否有新生成的文件和時間戳。

### 3. 測試語音合成

```bash
cd /home/ubuntu/.openclaw/workspace/skills/cantonese-voice
source /home/ubuntu/CosyVoice/cosyvoice-env/bin/activate

python voice_tts.py --text "測試" --output /home/ubuntu/桌面/ok/test.wav
```

記錄實際合成時間。

---

## 修復方案

### ✅ 方案1：添加錯誤反饋 (立即)

**文件**: `voice_integration.py` 的 `respond_speech` 方法

**改進**:
- 添加超時警告
- 錯誤時立即返回文字回應
- 記錄合成開始/結束時間

### ⚡ 方案2：優化文本長度 (短期)

**限制**: 每次回應最多 50 個中文字

**實現**: 在 `respond_speech` 中添加：
```python
# 截斷過長文本
if len(processed_text) > 50:
    processed_text = processed_text[:50] + "..."
    print("⚠️ 文本過長，已截斷為50字")
```

### 🔧 方案3：檢查 OpenClaw 超時配置 (中期)

檢查 `openclaw.json` 中是否有超時設定，如果有，增加超時時間。

---

## 臨時變通方案

### 用戶操作

1. **短文本優先**: 盡量使用簡短回應
2. **關閉語音輸出**: 如果等不及，發送 `）` 暫時關閉
3. **重試**: 如果收到錯誤，稍微等待後重試

### AI 角色設定

在系統提示中添加：
```
當語音輸出開啟時：
- 儘量使用簡短回應（<50字）
- 如果回應過長，僅發送文字，不生成語音
- 錯誤時始終返回文字回應，確保用戶收到信息
```

---

## 已知限制

| 項目 | 說明 |
|------|------|
| 模型 | Fun-CosyVoice3-0.5B |
| 硬件 | N100 CPU（無 GPU 加速） |
| 合成時間 | ~110秒/每秒音頻（RTF 12.43） |
| 典型等待 | 33-55秒（3-5秒音頻） |

---

## 優化建議（未來）

1. **更快的 TTS 模型**: 研究其他支持廣東話的輕量級模型
2. **GPU 加速**: 如果有 GPU，使用 CUDA 加速
3. **流式輸出**: 實現邊合成邊播放（降低感知延遲）
4. **預合成常用語音**: 複用常用回應的音頻

---

## 最後更新

**日期**: 2026-02-11 15:10
**版本**: 1.1
**狀態**: 已記錄問題，正在改進
